.PHONY: help upload-dev upload-test upload-build upload-clean upload-up upload-down upload-logs upload-verify upload-perf

.DEFAULT_GOAL := help

help: ## Show file upload feature commands
	@echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
	@echo 'â•‘         Form.io File Upload Feature - Development             â•‘'
	@echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
	@echo ''
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ''

# Include base Makefile for core services
include Makefile.local

# Development Environment
upload-dev: local-up ## ğŸš€ Start complete file upload development environment
	@echo ""
	@echo "ğŸš€ Starting file upload development stack..."
	@docker-compose -f docker-compose.upload.yml up -d
	@echo ""
	@echo "â³ Waiting for TUS server to be ready..."
	@sleep 5
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  âœ… File upload environment ready!                             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Services running:"
	@echo "  ğŸ“¦ MongoDB:        mongodb://localhost:27017"
	@echo "  ğŸ—„ï¸  GCS Emulator:   http://localhost:4443"
	@echo "  ğŸŒ Form.io Server: http://localhost:3001"
	@echo "  ğŸ“¤ TUS Server:     http://localhost:1080"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Run 'make upload-verify' to check all services"
	@echo "  2. Run 'make test-app' to start the test application"
	@echo "  3. Upload a file to test the feature"
	@echo ""

upload-up: ## â¬†ï¸  Start only file upload services (requires base services)
	@echo "â¬†ï¸  Starting file upload services..."
	@docker-compose -f docker-compose.upload.yml up -d
	@echo "âœ… File upload services started"

upload-down: ## â¬‡ï¸  Stop file upload services (keeps base services running)
	@echo "â¬‡ï¸  Stopping file upload services..."
	@docker-compose -f docker-compose.upload.yml down
	@echo "âœ… File upload services stopped"

upload-logs: ## ğŸ“œ Show logs from file upload services
	@docker-compose -f docker-compose.upload.yml logs -f

upload-logs-tus: ## ğŸ“‹ Show TUS server logs only
	@echo "ğŸ“‹ TUS Server Logs (Ctrl+C to exit)"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@docker-compose -f docker-compose.upload.yml logs -f tus-server

# Build and Test
upload-build: ## ğŸ”¨ Build all packages for file upload feature
	@echo "ğŸ”¨ Building all packages..."
	@echo ""
	@echo "Building formio-core..."
	@cd formio-core && npm install && npm run build
	@echo ""
	@echo "Building formio-react..."
	@cd formio-react && npm install && npm run build
	@echo ""
	@echo "Building formio server..."
	@cd formio && npm install && npm run build || echo "No build script"
	@echo ""
	@echo "Building test app..."
	@cd test-app && npm install && npm run build
	@echo ""
	@echo "âœ… All packages built successfully"

upload-test: ## ğŸ§ª Run complete test suite for file upload
	@echo "ğŸ§ª Running file upload test suite..."
	@echo ""
	@echo "1ï¸âƒ£ Unit tests..."
	@make upload-test-unit
	@echo ""
	@echo "2ï¸âƒ£ Integration tests..."
	@make upload-test-integration
	@echo ""
	@echo "3ï¸âƒ£ E2E tests..."
	@make upload-test-e2e
	@echo ""
	@echo "âœ… All tests completed"

upload-test-unit: ## ğŸ§ª Run unit tests only
	@echo "Running unit tests..."
	@cd formio && npm test || echo "No unit tests configured"
	@cd formio-core && npm test || echo "No unit tests configured"
	@cd formio-react && npm test || echo "No unit tests configured"

upload-test-integration: ## ğŸ§ª Run integration tests
	@echo "Running integration tests..."
	@echo "Prerequisites: Services must be running (make upload-dev)"
	@cd formio && npm run test:integration || echo "No integration tests configured"

upload-test-e2e: ## ğŸ§ª Run all E2E tests with Playwright
	@echo "Running E2E tests..."
	@echo "Prerequisites: All services must be running"
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e

upload-test-e2e-tus: ## ğŸ§ª Run TUS upload E2E tests only
	@echo "Running TUS-specific E2E tests..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:tus

upload-test-e2e-uppy: ## ğŸ§ª Run Uppy integration E2E tests only
	@echo "Running Uppy-specific E2E tests..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:uppy

upload-test-e2e-edge: ## ğŸ§ª Run edge case E2E tests
	@echo "Running edge case E2E tests..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:edge

upload-test-e2e-visual: ## ğŸ¨ Run visual regression E2E tests
	@echo "Running visual regression tests..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:visual

upload-test-e2e-debug: ## ğŸ› Run E2E tests in debug mode (headed browser)
	@echo "Running E2E tests in debug mode..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:debug

upload-test-e2e-ui: ## ğŸ‘ï¸  Run E2E tests with Playwright UI mode
	@echo "Opening Playwright UI..."
	@cd test-app && npx playwright install --with-deps chromium || true
	@cd test-app && npm run test:e2e:ui

upload-test-e2e-report: ## ğŸ“Š Generate and open HTML test report
	@echo "Generating HTML test report..."
	@cd test-app && npx playwright show-report playwright-report || echo "No report available. Run tests first."

upload-test-e2e-update-snapshots: ## ğŸ“¸ Update visual regression baselines
	@echo "âš ï¸  WARNING: This will update all visual regression baselines!"
	@echo "Press Ctrl+C to cancel, or wait 5 seconds..."
	@sleep 5
	@cd test-app && npm run test:e2e:update-snapshots
	@echo "âœ… Visual baselines updated"

upload-test-e2e-ci: ## ğŸš€ Run E2E tests in CI mode (isolated environment)
	@echo "Running E2E tests in CI mode..."
	@docker-compose -f docker-compose.test.yml up -d
	@echo "Waiting for services..."
	@sleep 30
	@cd test-app && npx playwright install --with-deps chromium firefox webkit
	@cd test-app && npm run test:e2e
	@docker-compose -f docker-compose.test.yml down -v
	@echo "âœ… CI tests complete"

upload-test-coverage: ## ğŸ“Š Generate test coverage report
	@echo "Generating coverage report..."
	@cd formio && npm run test:coverage || npm test -- --coverage
	@echo ""
	@echo "Coverage report: formio/coverage/lcov-report/index.html"

# Verification and Debugging
upload-verify: ## âœ… Verify all file upload services are healthy
	@echo "âœ… Checking file upload service health..."
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo -n "MongoDB:        "
	@docker-compose -f docker-compose.local.yml exec -T mongodb mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo -n "GCS Emulator:   "
	@curl -s http://localhost:4443/storage/v1/b > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo -n "Form.io Server: "
	@curl -s http://localhost:3001/health > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo -n "TUS Server:     "
	@curl -s http://localhost:1080/ > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo ""
	@echo "GCS Bucket Status:"
	@curl -s http://localhost:4443/storage/v1/b/local-formio-uploads | jq -r '"  ğŸ“¦ \(.name) (ready for uploads)"' || echo "  âŒ Bucket not initialized"
	@echo ""

upload-verify-files: ## ğŸ” List all uploaded files
	@echo "ğŸ” Files in GCS bucket:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@curl -s http://localhost:4443/storage/v1/b/local-formio-uploads/o | jq -r '.items[]? | "  ğŸ“„ \(.name)\n     Size: \(.size) bytes\n     Type: \(.contentType)\n     Created: \(.timeCreated)\n"' || echo "  (no files uploaded yet)"
	@echo ""

upload-verify-config: ## ğŸ”§ Show current configuration
	@echo "ğŸ”§ File Upload Configuration:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@docker-compose -f docker-compose.local.yml exec -T formio-server env | grep -E '^FORMIO_|^MONGO|^PORT' || echo "Server not running"
	@echo ""

# Performance Testing
upload-perf: ## âš¡ Run performance tests for file uploads
	@echo "âš¡ Running file upload performance tests..."
	@echo ""
	@command -v k6 >/dev/null 2>&1 || { echo "âŒ k6 not installed. Install from https://k6.io"; exit 1; }
	@echo "Creating load test script..."
	@cat > /tmp/upload-load-test.js << 'EOF'; \
	import http from 'k6/http'; \
	import { check, sleep } from 'k6'; \
	export const options = { \
	  stages: [ \
	    { duration: '30s', target: 10 }, \
	    { duration: '1m', target: 10 }, \
	    { duration: '30s', target: 0 }, \
	  ], \
	}; \
	export default function () { \
	  const res = http.get('http://localhost:3001/health'); \
	  check(res, { 'status is 200': (r) => r.status === 200 }); \
	  sleep(1); \
	} \
	EOF
	@k6 run /tmp/upload-load-test.js
	@echo ""
	@echo "âœ… Performance test completed"

upload-perf-report: ## ğŸ“Š Generate performance test report
	@echo "ğŸ“Š Generating performance report..."
	@k6 run --out json=/tmp/k6-results.json /tmp/upload-load-test.js || echo "Run 'make upload-perf' first"

# Cleanup
upload-clean: ## ğŸ§¹ Clean up build artifacts and caches
	@echo "ğŸ§¹ Cleaning up build artifacts..."
	@cd formio && rm -rf node_modules dist coverage .next || true
	@cd formio-core && rm -rf node_modules dist coverage || true
	@cd formio-react && rm -rf node_modules dist coverage || true
	@cd test-app && rm -rf node_modules dist coverage .next || true
	@echo "âœ… Cleanup complete"

upload-clean-all: upload-clean local-reset ## ğŸ—‘ï¸  Complete cleanup (deletes all data)
	@docker-compose -f docker-compose.upload.yml down -v
	@echo "âœ… All file upload data deleted"

# Database Management
upload-db-backup: ## ğŸ’¾ Backup MongoDB database
	@echo "ğŸ’¾ Backing up MongoDB..."
	@mkdir -p backups
	@docker-compose -f docker-compose.local.yml exec -T mongodb mongodump --db formioapp --archive > backups/formio-$(shell date +%Y%m%d-%H%M%S).dump
	@echo "âœ… Backup saved to backups/"

upload-db-restore: ## ğŸ“¥ Restore MongoDB database (requires BACKUP_FILE=...)
	@echo "ğŸ“¥ Restoring MongoDB from $(BACKUP_FILE)..."
	@test -f $(BACKUP_FILE) || { echo "âŒ Backup file not found. Usage: make upload-db-restore BACKUP_FILE=backups/formio-XXXXXX.dump"; exit 1; }
	@docker-compose -f docker-compose.local.yml exec -T mongodb mongorestore --db formioapp --archive < $(BACKUP_FILE)
	@echo "âœ… Database restored"

upload-db-reset: ## ğŸ”„ Reset database to clean state
	@echo "âš ï¸  WARNING: This will delete all database data!"
	@echo "Press Ctrl+C to cancel, or wait 5 seconds..."
	@sleep 5
	@docker-compose -f docker-compose.local.yml exec -T mongodb mongosh formioapp --eval "db.dropDatabase()"
	@echo "âœ… Database reset. Restart Form.io server to reinitialize."

# Deployment
upload-deploy-local: upload-build upload-dev ## ğŸš€ Full local deployment
	@echo "ğŸš€ Deploying file upload feature locally..."
	@make upload-verify
	@echo ""
	@echo "âœ… Local deployment complete!"

upload-deploy-staging: ## ğŸ­ Deploy to staging environment
	@echo "ğŸ­ Deploying to staging..."
	@./scripts/deploy-upload-feature.sh staging
	@echo "âœ… Staging deployment complete"

upload-deploy-prod: ## ğŸŒ Deploy to production (requires confirmation)
	@echo "âš ï¸  WARNING: Deploying to PRODUCTION!"
	@echo "Type 'DEPLOY' to continue, or Ctrl+C to cancel:"
	@read confirm && [ "$$confirm" = "DEPLOY" ] || { echo "âŒ Deployment cancelled"; exit 1; }
	@./scripts/deploy-upload-feature.sh production
	@echo "âœ… Production deployment complete"

# Development Workflow
upload-watch: ## ğŸ‘ï¸  Watch and rebuild packages on changes
	@echo "ğŸ‘ï¸  Watching for changes..."
	@echo "Press Ctrl+C to stop"
	@echo ""
	@trap 'kill 0' EXIT; \
	(cd formio-core && npm run build:watch) & \
	(cd formio-react && npm run build:watch) & \
	wait

upload-dev-full: ## ğŸ”§ Full development setup (build + start + watch)
	@echo "ğŸ”§ Starting full development environment..."
	@make upload-build
	@make upload-dev
	@make upload-verify
	@echo ""
	@echo "Starting watch mode for packages..."
	@make upload-watch

# Documentation
upload-docs: ## ğŸ“š Generate API documentation
	@echo "ğŸ“š Generating API documentation..."
	@cd formio && npm run docs || echo "No docs script configured"
	@echo "âœ… Documentation generated"

upload-env-docs: ## ğŸ“‹ Show environment variable documentation
	@echo "ğŸ“‹ File Upload Environment Variables:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@cat << 'EOF'
	Core Configuration:
	  MONGO                  - MongoDB connection string
	  JWT_SECRET            - JWT signing secret
	  DB_SECRET             - Database encryption secret
	  PORT                  - Server port (default: 3001)

	File Storage (GCS):
	  FORMIO_FILES_SERVER   - Storage backend (set to 'gcs')
	  FORMIO_S3_SERVER      - GCS/S3 endpoint URL
	  FORMIO_S3_BUCKET      - Storage bucket name
	  FORMIO_S3_REGION      - Storage region
	  FORMIO_S3_KEY         - Access key ID
	  FORMIO_S3_SECRET      - Secret access key

	TUS Upload (Resumable):
	  TUS_UPLOAD_DIR        - Upload directory path
	  TUS_MAX_SIZE          - Max upload size (bytes)
	  TUS_BASE_PATH         - TUS endpoint base path

	CORS & Security:
	  CORS_ORIGIN           - Allowed origins (comma-separated)
	  ROOT_EMAIL            - Admin email
	  ROOT_PASSWORD         - Admin password

	Debug:
	  DEBUG                 - Debug namespaces (e.g., formio:*)
	  NODE_ENV              - Environment (development/production)
	EOF
	@echo ""

# Status and Info
upload-status: upload-verify ## ğŸ“Š Show complete system status
	@echo ""
	@echo "Container Status:"
	@docker-compose -f docker-compose.local.yml ps
	@docker-compose -f docker-compose.upload.yml ps 2>/dev/null || echo "(no upload services running)"
	@echo ""
	@echo "Disk Usage:"
	@du -sh ./formio ./formio-core ./formio-react ./test-app 2>/dev/null || true
	@echo ""

upload-ports: ## ğŸ”Œ Show all service ports
	@echo "ğŸ”Œ Service Ports:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  Test App:       http://localhost:64849"
	@echo "  Form.io Server: http://localhost:3001"
	@echo "  TUS Server:     http://localhost:1080"
	@echo "  GCS Emulator:   http://localhost:4443"
	@echo "  MongoDB:        mongodb://localhost:27017"
	@echo ""
	@echo "Health Endpoints:"
	@echo "  Form.io:        http://localhost:3001/health"
	@echo "  TUS:            http://localhost:1080/"
	@echo "  GCS:            http://localhost:4443/storage/v1/b"
	@echo ""

# Quick shortcuts
dev: upload-dev ## Alias for upload-dev
test: upload-test ## Alias for upload-test
build: upload-build ## Alias for upload-build
clean: upload-clean ## Alias for upload-clean
verify: upload-verify ## Alias for upload-verify
# Test Infrastructure Documentation

## Test Directory Structure

### Primary Test Directories

1. **`form-client-web-app/tests/`** âœ… PRIMARY E2E TEST DIRECTORY
   - **Purpose**: End-to-end testing for the Form.io client web application
   - **Framework**: Playwright
   - **Config**: `form-client-web-app/playwright.config.ts`
   - **Subdirectories**:
     - `e2e/` - End-to-end test specs (29 files)
     - `utils/` - Test utilities and helpers (16 files)
     - `setup/` - Test setup scripts and bootstrap
     - `fixtures/` - Test data and mocks (14 files)
     - `pages/` - Page object models (9 files)
     - `integration/` - Integration tests (4 files)
     - `backend/` - Backend API testing
     - `unit/` - Unit tests
     - `performance/` - Performance benchmarks
     - `examples/` - Test examples
     - `config/` - Configuration files

2. **`tests/`** âœ… ROOT-LEVEL SHARED TESTS
   - **Purpose**: Shared test infrastructure and cross-package tests
   - **Framework**: Playwright
   - **Config**: `tests/playwright.config.ts`
   - **Subdirectories**:
     - `e2e/` - Cross-package E2E tests (7 files)
     - `utils/` - Shared test utilities (8 files)
     - `fixtures/` - Shared test data (4 files)
     - `integration/` - Cross-package integration tests
     - `page-objects/` - Shared page objects
     - `reporters/` - Custom test reporters (6 files)
     - `visual/` - Visual regression tests (5 files)

3. **`test-app/tests/`** âœ… LEGACY TEST APP
   - **Purpose**: Legacy test application directory
   - **Status**: May be deprecated in favor of `form-client-web-app/tests/`
   - **Note**: Check if this can be consolidated with form-client-web-app

## Test Infrastructure Components

### 1. Playwright Configuration

**Primary Config**: `form-client-web-app/playwright.config.ts`

```typescript
- testDir: './tests/e2e'
- baseURL: http://localhost:64849
- webServer: npm run dev (auto-start)
- globalSetup: './tests/utils/global-setup.ts'
- globalTeardown: './tests/utils/global-teardown.ts'
- workers: 4 (parallel execution)
- browsers: chromium, firefox, webkit, mobile-chrome, mobile-safari, edge, chrome
```

### 2. Global Setup (`form-client-web-app/tests/utils/global-setup.ts`)

**Responsibilities**:

- âœ… Health check test app (http://localhost:64849)
- âœ… Health check Form.io server (http://localhost:3001)
- âœ… Health check GCS emulator (http://localhost:4443)
- âœ… Generate standard test files
- âœ… Run Form.io bootstrap (via `tests/setup/formio-bootstrap.sh`)
- âœ… Load `.env.test` configuration

**Bootstrap Script**: `form-client-web-app/tests/setup/formio-bootstrap.sh`

- **Status**: âœ… Stub script created (exits 0)
- **Purpose**: Bootstrap Form.io with test data
- **Current Behavior**: Skips actual bootstrap (placeholder)
- **Future**: Implement full bootstrap logic for test environment setup

### 3. Package.json Scripts

**form-client-web-app/package.json**:

```json
{
  "test": "vitest", // Unit tests (Vitest)
  "test:watch": "vitest --watch",
  "test:ui": "vitest --ui",
  "test:coverage": "vitest --coverage",
  "test:e2e": "playwright test", // âœ… NEW
  "test:e2e:ui": "playwright test --ui", // âœ… NEW
  "test:e2e:debug": "playwright test --debug", // âœ… NEW
  "test:e2e:headed": "playwright test --headed" // âœ… NEW
}
```

### 4. Dependencies

**Installed**:

- âœ… `@playwright/test@^1.55.1` - E2E testing framework
- âœ… Chromium browser with system dependencies

**Other Test Dependencies**:

- `vitest@^1.0.4` - Unit test runner
- `@vitest/ui@^1.0.4` - Vitest UI
- `@vitest/coverage-v8@^1.0.4` - Code coverage
- `@testing-library/react@^14.1.2` - React testing utilities
- `@testing-library/jest-dom@^6.1.5` - DOM matchers

## Running Tests

### E2E Tests (Playwright)

```bash
cd form-client-web-app

# Run all E2E tests
npm run test:e2e

# Run with UI mode (recommended for debugging)
npm run test:e2e:ui

# Run in headed mode (see browser)
npm run test:e2e:headed

# Run specific test file
npm run test:e2e -- tests/e2e/upload.spec.ts

# Debug specific test
npm run test:e2e:debug -- tests/e2e/upload.spec.ts

# Run only chromium tests
npm run test:e2e -- --project=chromium

# Update snapshots
npm run test:e2e -- --update-snapshots
```

### Unit Tests (Vitest)

```bash
cd form-client-web-app

# Run unit tests
npm test

# Watch mode
npm run test:watch

# UI mode
npm run test:ui

# Coverage report
npm run test:coverage
```

## Environment Configuration

### Required Services

**Docker Compose Services** (start with `make local-up`):

1. MongoDB (localhost:27017)
2. Redis (localhost:6379)
3. GCS Emulator (localhost:4443)
4. Form.io Server (localhost:3001)
5. TUS Server (localhost:1080)

### Environment Variables

**`.env.test`** (auto-generated by bootstrap):

```bash
FORMIO_JWT_TOKEN=<auto-generated>
FORMIO_FORM_ID=<auto-generated>
FORMIO_BASE_URL=http://localhost:3001
TEST_APP_URL=http://localhost:64849
GCS_BASE_URL=http://localhost:4443
TUS_ENDPOINT=http://localhost:1080/files/
```

## Test Structure Best Practices

### 1. Test Organization

```
form-client-web-app/tests/
â”œâ”€â”€ e2e/              # User journey tests
â”œâ”€â”€ integration/      # API + component integration
â”œâ”€â”€ unit/             # Isolated component tests
â”œâ”€â”€ fixtures/         # Test data generators
â”œâ”€â”€ pages/            # Page object models
â””â”€â”€ utils/            # Shared test utilities
```

### 2. Test Naming Convention

```typescript
// E2E Tests
describe('File Upload', () => {
  test('should upload PDF file via TUS', async ({ page }) => {
    // Test implementation
  });
});

// Unit Tests
describe('FileValidator', () => {
  it('should validate magic numbers', () => {
    // Test implementation
  });
});
```

### 3. Parallel Execution

- **E2E Tests**: 4 parallel workers (configurable)
- **Unit Tests**: Automatic parallelization by Vitest
- **CI/CD**: 2 retries on failure

## Troubleshooting

### Common Issues

**1. Bootstrap script missing**:

- âœ… FIXED: Created stub script at
  `form-client-web-app/tests/setup/formio-bootstrap.sh`

**2. Playwright not installed**:

- âœ… FIXED: Added `@playwright/test@^1.55.1` to devDependencies
- âœ… FIXED: Installed Chromium with system dependencies

**3. Port conflicts**:

- Test app: 64849
- Form.io: 3001
- GCS: 4443
- TUS: 1080
- Check `docker-compose.yml` for port mappings

**4. Services not running**:

```bash
# Start all services
make local-up

# Check service health
docker-compose ps

# View logs
docker-compose logs -f formio-server
```

### Debug Commands

```bash
# Check Playwright installation
npx playwright --version

# List installed browsers
npx playwright install --dry-run

# Validate config
npx playwright test --list

# Show test report
npx playwright show-report
```

## CI/CD Integration

### GitHub Actions (Future)

```yaml
- name: Install dependencies
  run: npm ci

- name: Install Playwright
  run: npx playwright install --with-deps

- name: Run E2E tests
  run: npm run test:e2e

- name: Upload test results
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: playwright-report/
```

## Migration Status

### Completed âœ…

1. âœ… Playwright installed in form-client-web-app
2. âœ… Test scripts added to package.json
3. âœ… Bootstrap script stub created
4. âœ… Chromium browser installed
5. âœ… Test infrastructure validated

### Pending ðŸ“‹

1. ðŸ“‹ Consolidate test-app/tests/ into form-client-web-app/tests/
2. ðŸ“‹ Implement full bootstrap script logic
3. ðŸ“‹ Add CI/CD GitHub Actions workflow
4. ðŸ“‹ Document test data fixtures
5. ðŸ“‹ Create test coverage reports

## Summary

**Primary Test Directory**: `form-client-web-app/tests/` **Framework**:
Playwright + Vitest **Status**: âœ… Fully operational **Bootstrap**: âœ… Stub
created (implement full logic later) **Browser**: âœ… Chromium installed **Test
Command**: `npm run test:e2e`

Last Updated: 2025-10-10

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks with lint-staged..."

# Run lint-staged (will lint only staged files)
pnpm exec lint-staged

# Check for .env files
if git diff --cached --name-only | grep -q '\.env$'; then
  echo "‚ùå Error: Attempting to commit .env file"
  echo "   Remove .env files from staging"
  exit 1
fi

# Check for source map files
if git diff --cached --name-only | grep -q '\.map$'; then
  echo "‚ùå Error: Attempting to commit source map files"
  echo "   Source maps should not be committed (security risk)"
  exit 1
fi

# Check for secrets in staged files
echo "Checking for exposed secrets..."
STAGED_ALL=$(git diff --cached --name-only --diff-filter=ACM || true)

if [ -n "$STAGED_ALL" ]; then
  for file in $STAGED_ALL; do
    if [ -f "$file" ]; then
      # Check for potential secrets (relaxed pattern)
      if grep -qE '(api[_-]?key|password|secret[_-]?key|bearer[[:space:]]+[a-zA-Z0-9]{30,})' "$file"; then
        if [[ ! "$file" =~ (test|spec|mock|fixture|example) ]]; then
          echo "‚ö†Ô∏è  Warning: Potential secret pattern detected in: $file"
          echo "   Please review manually. Use environment variables for sensitive data."
        fi
      fi
    fi
  done
fi

echo "‚úÖ Pre-commit checks passed!"

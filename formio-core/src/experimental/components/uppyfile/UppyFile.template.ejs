<%
/**
 * UppyFile Component Template
 *
 * Renders the HTML structure for Uppy file upload component.
 * The actual Uppy Dashboard is initialized via JavaScript in UppyFile.ts
 */

const componentId = ctx.inputId || `uppyfile-${ctx.component.key}`;
const dashboardId = `${componentId}-dashboard`;
const containerId = `${componentId}-container`;

// Build restrictions display text
const restrictions = ctx.component.uppyConfig?.restrictions || {};
const restrictionTexts = [];

if (restrictions.maxFileSize) {
  const sizeMB = Math.round(restrictions.maxFileSize / (1024 * 1024));
  restrictionTexts.push(`Max file size: ${sizeMB}MB`);
}

if (restrictions.maxNumberOfFiles) {
  restrictionTexts.push(`Max ${restrictions.maxNumberOfFiles} file${restrictions.maxNumberOfFiles > 1 ? 's' : ''}`);
}

if (restrictions.allowedFileTypes && restrictions.allowedFileTypes.length > 0) {
  restrictionTexts.push(`Allowed types: ${restrictions.allowedFileTypes.join(', ')}`);
}

const dashboardConfig = ctx.component.dashboard || {};
const isInline = dashboardConfig.inline !== false;

%>

<div class="<%= ctx.className %>" ref="<%= ctx.ref %>" id="<%= containerId %>">
  <% if (ctx.component.label) { %>
    <label for="<%= dashboardId %>" class="formio-component-label">
      <%= ctx.t(ctx.component.label) %>
      <% if (ctx.component.validate?.required) { %>
        <span class="field-required">*</span>
      <% } %>
      <% if (ctx.component.tooltip) { %>
        <i class="fa fa-question-sign text-muted"
           data-tooltip="<%= ctx.t(ctx.component.tooltip) %>"
           ref="tooltip"></i>
      <% } %>
    </label>
  <% } %>

  <% if (ctx.component.description) { %>
    <div class="formio-component-description">
      <%= ctx.t(ctx.component.description) %>
    </div>
  <% } %>

  <% if (restrictionTexts.length > 0) { %>
    <div class="uppy-restrictions text-muted small mb-2">
      <%= restrictionTexts.join(' â€¢ ') %>
    </div>
  <% } %>

  <!-- Uppy Dashboard Container -->
  <div class="uppy-dashboard-container"
       id="<%= dashboardId %>"
       ref="uppyDashboard"
       data-component-key="<%= ctx.component.key %>"
       <% if (dashboardConfig.width) { %>
         style="width: <%= typeof dashboardConfig.width === 'number' ? dashboardConfig.width + 'px' : dashboardConfig.width %>;"
       <% } %>
  ></div>

  <!-- Upload Status Display (for inline: false mode) -->
  <% if (!isInline) { %>
    <div class="uppy-status-display" ref="statusDisplay" style="display: none;">
      <div class="alert alert-info">
        <div class="uppy-status-message" ref="statusMessage"></div>
        <div class="uppy-status-progress" ref="statusProgress">
          <div class="progress mt-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 ref="progressBar"
                 role="progressbar"
                 style="width: 0%"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100">
              0%
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Uploaded Files List -->
  <div class="uppy-uploaded-files" ref="uploadedFilesList" style="display: none;">
    <div class="card mt-3">
      <div class="card-header bg-success text-white">
        <i class="fa fa-check-circle"></i>
        <span ref="uploadedFilesTitle">Uploaded Files</span>
      </div>
      <ul class="list-group list-group-flush" ref="fileList"></ul>
    </div>
  </div>

  <!-- Error Display -->
  <div class="uppy-error-container" ref="errorContainer" style="display: none;">
    <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
      <strong><i class="fa fa-exclamation-triangle"></i> Error:</strong>
      <span ref="errorMessage"></span>
      <button type="button"
              class="close"
              data-dismiss="alert"
              aria-label="Close"
              ref="errorDismiss">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  </div>

  <!-- Hidden Input to Store File Data -->
  <input type="hidden"
         name="<%= ctx.component.key %>"
         ref="hiddenInput"
         value="<%= ctx.dataValue ? JSON.stringify(ctx.dataValue) : '' %>"
  />

  <% if (ctx.component.tooltip) { %>
    <div class="formio-component-tooltip" ref="tooltipContent" style="display: none;">
      <%= ctx.t(ctx.component.tooltip) %>
    </div>
  <% } %>
</div>

<!-- Template for uploaded file list item -->
<template id="<%= componentId %>-file-item-template">
  <li class="list-group-item d-flex justify-content-between align-items-center">
    <div class="file-info">
      <i class="fa fa-file mr-2 file-icon"></i>
      <span class="file-name"></span>
      <small class="text-muted file-size ml-2"></small>
    </div>
    <div class="file-actions">
      <a href="#"
         class="btn btn-sm btn-outline-primary file-download"
         target="_blank"
         title="Download">
        <i class="fa fa-download"></i>
      </a>
      <button type="button"
              class="btn btn-sm btn-outline-danger file-remove ml-1"
              title="Remove">
        <i class="fa fa-trash"></i>
      </button>
    </div>
  </li>
</template>
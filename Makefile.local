.PHONY: help local-up local-down local-reset local-logs local-logs-formio form-client-web-app verify-upload quick-start

.DEFAULT_GOAL := help

help: ## Show this help message
	@echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
	@echo 'â•‘         Form.io Local Development Environment                  â•‘'
	@echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
	@echo ''
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ''

local-up: ## ğŸš€ Start local development environment (MongoDB + GCS + Form.io)
	@echo "ğŸš€ Starting local development environment..."
	@docker-compose -f docker-compose.yml up -d
	@echo ""
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	@echo ""
	@echo "ğŸª£ Initializing GCS emulator..."
	@./scripts/init-gcs-local.sh
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  âœ… Local environment ready!                                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Services running:"
	@echo "  ğŸ“¦ MongoDB:        mongodb://localhost:27017"
	@echo "  ğŸ—„ï¸  GCS Emulator:   http://localhost:4443"
	@echo "  ğŸŒ Form.io Server: http://localhost:3001"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Run 'make form-client-web-app' to start the test application"
	@echo "  2. Open http://localhost:64849 in your browser"
	@echo "  3. Run 'make local-logs-formio' to watch server logs"
	@echo ""

local-down: ## ğŸ›‘ Stop local development environment (keeps data)
	@echo "ğŸ›‘ Stopping local development environment..."
	@docker-compose -f docker-compose.yml down
	@echo "âœ… Services stopped (data preserved)"

local-reset: ## ğŸ—‘ï¸  Reset local environment (delete ALL data)
	@echo "âš ï¸  WARNING: This will delete all local data!"
	@echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
	@sleep 5
	@echo ""
	@echo "ğŸ—‘ï¸  Resetting local environment..."
	@docker-compose -f docker-compose.yml down -v
	@echo "âœ… All data deleted. Run 'make local-up' to start fresh."

local-logs: ## ğŸ“œ Show logs from all services (follow mode)
	@docker-compose -f docker-compose.yml logs -f

local-logs-formio: ## ğŸ“‹ Show Form.io server logs only (follow mode)
	@echo "ğŸ“‹ Form.io Server Logs (Ctrl+C to exit)"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@docker-compose -f docker-compose.yml logs -f formio-server

local-logs-gcs: ## ğŸª£ Show GCS emulator logs only (follow mode)
	@docker-compose -f docker-compose.yml logs -f gcs-emulator

local-logs-mongo: ## ğŸ“¦ Show MongoDB logs only (follow mode)
	@docker-compose -f docker-compose.yml logs -f mongodb

form-client-web-app: ## ğŸ§ª Start React test app on port 64849
	@echo "ğŸ§ª Starting React test application..."
	@cd form-client-web-app && npm install && npm run dev

form-client-web-app-build: ## ğŸ“¦ Build test app for production
	@echo "ğŸ“¦ Building test app..."
	@cd form-client-web-app && npm install && npm run build

verify-upload: ## ğŸ” Check files in GCS emulator
	@echo "ğŸ” Files in local GCS bucket:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@curl -s http://localhost:4443/storage/v1/b/local-formio-uploads/o | jq -r '.items[]? | "  ğŸ“„ \(.name) (\(.size) bytes)"' || echo "  (no files uploaded yet)"
	@echo ""

verify-services: ## âœ… Check if all services are healthy
	@echo "âœ… Checking service health..."
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo -n "MongoDB:        "
	@docker-compose -f docker-compose.yml exec -T mongodb mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo -n "GCS Emulator:   "
	@curl -s http://localhost:4443/storage/v1/b > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo -n "Form.io Server: "
	@curl -s http://localhost:3001/health > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Not running"
	@echo ""

quick-start: local-up ## ğŸƒ Quick start: Start everything and open test app
	@echo ""
	@echo "â³ Waiting for services to stabilize..."
	@sleep 5
	@echo ""
	@make verify-services
	@echo ""
	@echo "ğŸ‰ Opening test app..."
	@cd form-client-web-app && npm install && npm run dev &
	@sleep 3
	@open http://localhost:64849 2>/dev/null || echo "Open http://localhost:64849 in your browser"

# Development workflow commands

dev-formio-core: ## ğŸ‘ï¸  Watch and rebuild formio-core on changes
	@echo "ğŸ‘ï¸  Watching formio-core for changes..."
	@cd formio-core && yarn install && yarn build:watch

dev-formio-react: ## ğŸ‘ï¸  Watch and rebuild formio-react on changes
	@echo "ğŸ‘ï¸  Watching formio-react for changes..."
	@cd formio-react && yarn install && yarn build

dev-formio-server-standalone: ## ğŸ”§ Run formio server standalone (no Docker)
	@echo "ğŸ”§ Running formio server in standalone mode..."
	@cd formio && npm install && npm run start:dev

rebuild-formio-server: ## ğŸ”¨ Rebuild formio server Docker image
	@echo "ğŸ”¨ Rebuilding formio server Docker image..."
	@docker-compose -f docker-compose.yml build formio-server
	@docker-compose -f docker-compose.yml up -d formio-server
	@echo "âœ… Form.io server rebuilt and restarted"

# Testing commands

test-integration: ## ğŸ§ª Run integration tests against local environment
	@echo "ğŸ§ª Running integration tests..."
	@cd formio && npm test

test-formio-core: ## ğŸ§ª Run formio-core unit tests
	@cd formio-core && yarn test

test-formio-react: ## ğŸ§ª Run formio-react unit tests
	@cd formio-react && yarn test

# Debugging commands

shell-formio: ## ğŸš Open shell in formio server container
	@docker-compose -f docker-compose.yml exec formio-server sh

shell-mongo: ## ğŸš Open MongoDB shell
	@docker-compose -f docker-compose.yml exec mongodb mongosh formioapp

inspect-gcs: ## ğŸ” Detailed GCS bucket inspection
	@echo "ğŸ” GCS Bucket Details:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@curl -s http://localhost:4443/storage/v1/b/local-formio-uploads | jq .
	@echo ""
	@echo "Files:"
	@curl -s http://localhost:4443/storage/v1/b/local-formio-uploads/o | jq '.items[]? | {name, size, contentType, timeCreated}'

clean-logs: ## ğŸ§¹ Clear Docker logs
	@echo "ğŸ§¹ Clearing Docker logs..."
	@docker-compose -f docker-compose.yml logs > /dev/null 2>&1
	@echo "âœ… Logs cleared"

# Status commands

status: verify-services ## ğŸ“Š Show full environment status

ports: ## ğŸ”Œ Show all ports in use
	@echo "ğŸ”Œ Service Ports:"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  Test App:       http://localhost:64849"
	@echo "  Form.io Server: http://localhost:3001"
	@echo "  GCS Emulator:   http://localhost:4443"
	@echo "  MongoDB:        mongodb://localhost:27017"
	@echo ""